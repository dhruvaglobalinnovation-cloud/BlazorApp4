@page "/weather"
@attribute [StreamRendering]
@using System.Linq
@using System.Collections.Generic
@using System.Net.Http.Json
@using BlazorApp4.Components.Models
@using ElementModel = BlazorApp4.Components.Models.Element
@using MudBlazor
@inject HttpClient httpClient

<PageTitle>Periodic Elements</PageTitle>

<MudPaper Class="pa-4">
    <MudDataGrid @ref="_elementGrid" T="ElementModel" Items="@_elements" ReadOnly="@_readOnly"
                 EditMode="DataGridEditMode.Cell"
                 StartedEditingItem="@StartedEditingItem" CanceledEditingItem="@CanceledEditingItem" CommittedItemChanges="@CommittedItemChanges"
                 Bordered="true" Dense="true" EditTrigger="@(_editTriggerRowClick ? DataGridEditTrigger.OnRowClick : DataGridEditTrigger.Manual)">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Periodic Elements</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="NewItemAsync">Add New Item</MudButton>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="@( (ElementModel x) => x.Number )" Title="Nr" Editable="false" />
            <PropertyColumn Property="@( (ElementModel x) => x.Sign )" Title="Sign" />
            <PropertyColumn Property="@( (ElementModel x) => x.Name )" Title="Name" />
            <PropertyColumn Property="@( (ElementModel x) => x.Position )" Title="Position">
                <EditTemplate Context="context">
                    <MudSelect @bind-Value="context.Item.Position" Required RequiredError="You must select a Position" Margin="@Margin.Dense">
                        <MudSelectItem Value="0">zero</MudSelectItem>
                        <MudSelectItem Value="1">one</MudSelectItem>
                        <MudSelectItem Value="17">seventeen</MudSelectItem>
                    </MudSelect>
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="@( (ElementModel x) => x.Molar )" Title="Molar mass" />
            <TemplateColumn Hidden="@_readOnly" CellClass="d-flex justify-between">
                <CellTemplate Context="context">
                    <MudIconButton Size="Size.Small" Icon="Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="@(async () => await context.Actions.StartEditingItemAsync())" />
                    <MudIconButton Size="Size.Small" Icon="Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteItem(context.Item))" />
                </CellTemplate>
                <EditTemplate Context="context">
                    <MudIconButton Size="Size.Small" Icon="Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteItem(context.Item))" />
                </EditTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>

    <div class="d-flex flex-wrap mt-3 align-items-center gap-2">
        <MudButton Variant="Variant.Outlined" OnClick="PrevPage" Disabled="@(_page <= 1)">Prev</MudButton>
        <MudText Typo="Typo.body2">Page @(_page) of @((int)Math.Ceiling((double)_total / _pageSize))</MudText>
        <MudButton Variant="Variant.Outlined" OnClick="NextPage" Disabled="@( (_page * _pageSize) >= _total )">Next</MudButton>

        <MudSelect T="int" @bind-Value="_pageSize" Class="ms-3" Dense="true">
            <MudSelectItem Value="5">5</MudSelectItem>
            <MudSelectItem Value="10">10</MudSelectItem>
            <MudSelectItem Value="20">20</MudSelectItem>
        </MudSelect>

        <MudTextField @bind-Value="_source" Placeholder="data source (json or db)" Class="ms-3" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Reload">Reload</MudButton>
        <MudText Class="ms-auto" Typo="Typo.caption">Total: @_total</MudText>
    </div>

    <MudExpansionPanels Class="mt-4">
        <MudExpansionPanel Text="Show Events">
            @foreach (var message in _events)
            {
                <MudText Typo="Typo.body2">@message</MudText>
            }
            @if(_events.Count > 0)
            {
                <div class="d-flex mt-3">
                    <MudSpacer />
                    <MudButton Variant="Variant.Filled" Color="Color.Default" OnClick="@(()=> _events.Clear())">Clear</MudButton>
                </div>
            }
        </MudExpansionPanel>
    </MudExpansionPanels>
</MudPaper>

@code {
    private List<ElementModel> _elements = new();
    private IEnumerable<ElementModel> _elementMasterList = Enumerable.Empty<ElementModel>();
    private bool _readOnly;
    private bool _editTriggerRowClick;
    private List<string> _events = new();
    private MudDataGrid<ElementModel> _elementGrid = default!;

    // paging
    private int _page = 1;
    private int _pageSize = 10;
    private int _total = 0;
    private string _source = "json";

    private class PagedResult<T>
    {
        public List<T>? Items { get; set; }
        public int Total { get; set; }
        public int Page { get; set; }
        public int PageSize { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadPageAsync(_page, _pageSize);
    }

    private async Task LoadPageAsync(int page, int pageSize)
    {
        try
        {
            var url = $"webapi/periodictable?source={_source}&page={page}&pageSize={pageSize}";
            var resp = await httpClient.GetFromJsonAsync<PagedResult<ElementModel>>(url);
            if (resp?.Items != null)
            {
                _elements = resp.Items;
                _total = resp.Total;
                _page = resp.Page;
                _pageSize = resp.PageSize;
            }
            else
            {
                _elements = new List<ElementModel>();
                _total = 0;
            }
        }
        catch (Exception ex)
        {
            _events.Insert(0, $"Load error: {ex.Message}");
            // fallback to previous behavior
            var list = new List<ElementModel>
            {
                new ElementModel { Number = 1, Sign = "H", Name = "Hydrogen", Position = 1, Molar = 1.008 },
                new ElementModel { Number = 2, Sign = "He", Name = "Helium", Position = 18, Molar = 4.0026 },
                new ElementModel { Number = 3, Sign = "Li", Name = "Lithium", Position = 1, Molar = 6.94 },
                new ElementModel { Number = 4, Sign = "Be", Name = "Beryllium", Position = 2, Molar = 9.0122 }
            };
            _elements = list.Take(pageSize).ToList();
            _total = list.Count;
        }
    }

    private async Task NextPage()
    {
        if ((_page * _pageSize) >= _total) return;
        _page++;
        await LoadPageAsync(_page, _pageSize);
    }

    private async Task PrevPage()
    {
        if (_page <= 1) return;
        _page--;
        await LoadPageAsync(_page, _pageSize);
    }

    private async Task Reload()
    {
        _page = 1;
        await LoadPageAsync(_page, _pageSize);
    }

    private async Task NewItemAsync()
    {
        var elem = new ElementModel();
        _elements.Insert(0, elem);
        await InvokeAsync(StateHasChanged);
        await Task.Yield();
        await _elementGrid.SetEditingItemAsync(elem);
    }

    private void DeleteItem(ElementModel item)
    {
        if (item == null) return;
        _elements.Remove(item);
        StateHasChanged();
    }

    private void StartedEditingItem(ElementModel item)
    {
        _events.Insert(0, $"StartedEditingItem: {System.Text.Json.JsonSerializer.Serialize(item)}");
    }

    private void CanceledEditingItem(ElementModel item)
    {
        _events.Insert(0, $"CanceledEditingItem: {System.Text.Json.JsonSerializer.Serialize(item)}");
    }

    private void CommittedItemChanges(ElementModel item)
    {
        // handle new item numbering
        if (item.Number == 0)
        {
            var max = _elementMasterList.Any() ? _elementMasterList.Max(x => x.Number) : 0;
            var maxLocal = _elements.Any() ? _elements.Max(x => x.Number) : 0;
            item.Number = Math.Max(max, maxLocal) + 1;
        }

        _events.Insert(0, $"CommittedItemChanges: {System.Text.Json.JsonSerializer.Serialize(item)}");
    }
}